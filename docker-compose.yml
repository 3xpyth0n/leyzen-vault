x-filebrowser-base: &filebrowser-base
  build:
    context: ./filebrowser
    args:
      FILEBROWSER_VERSION: ${FILEBROWSER_VERSION:-2.44.2}
  image: leyzen/filebrowser:latest
  env_file:
    - .env
  environment:
    FILEBROWSER_ADMIN_USER: ${FILEBROWSER_ADMIN_USER:?Set FILEBROWSER_ADMIN_USER in .env}
    FILEBROWSER_ADMIN_PASSWORD: ${FILEBROWSER_ADMIN_PASSWORD:?Set FILEBROWSER_ADMIN_PASSWORD in .env}
  expose:
    - "80"
  restart: on-failure
  healthcheck:
    test: ["CMD-SHELL", "curl -f http://localhost || exit 1"]
    interval: 1s
    timeout: 5s
    retries: 5
  volumes:
    - filebrowser-data:/srv
    - filebrowser-database:/database
    - filebrowser-config:/config
  depends_on:
    - orchestrator
  networks:
    - vault-net

services:
  filebrowser_web1:
    <<: *filebrowser-base
    container_name: filebrowser_web1

  filebrowser_web2:
    <<: *filebrowser-base
    container_name: filebrowser_web2

  filebrowser_web3:
    <<: *filebrowser-base
    container_name: filebrowser_web3

  haproxy:
    image: haproxy:2.8-alpine
    container_name: haproxy
    volumes:
      - ./haproxy:/usr/local/etc/haproxy:ro
    ports:
      - "8080:80"
    restart: on-failure
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg || exit 1",
        ]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - vault-net

  docker-proxy:
    build:
      context: ./docker-proxy
    container_name: docker-proxy
    restart: unless-stopped
    environment:
      DOCKER_PROXY_TOKEN: ${DOCKER_PROXY_TOKEN:?Set DOCKER_PROXY_TOKEN in .env}
      DOCKER_PROXY_TIMEOUT: ${DOCKER_PROXY_TIMEOUT:-30}
      LOG_LEVEL: ${DOCKER_PROXY_LOG_LEVEL:-INFO}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - control-net

  orchestrator:
    build:
      context: ./orchestrator
    container_name: orchestrator
    restart: on-failure
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://localhost/orchestrator || exit 1"]
      interval: 1s
      timeout: 10s
      retries: 5
    env_file:
      - .env
    environment:
      ORCHESTRATOR_LOG_DIR: /app/logs
    expose:
      - "8081"
    volumes:
      - ./orchestrator:/app:ro
      - orchestrator-logs:/app/logs
    depends_on:
      - docker-proxy
    networks:
      - vault-net
      - control-net

volumes:
  filebrowser-data:
  filebrowser-database:
  filebrowser-config:
  orchestrator-logs:

networks:
  vault-net:
    driver: bridge
  control-net:
    driver: bridge
