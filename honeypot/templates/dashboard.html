<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Honeypot Dashboard - Leyzen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/honeypot/static/dashboard.css" />
    <link rel="icon" type="image/png" href="/honeypot/static/favicon.png" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>Honeypot Dashboard</h1>
        <div class="controls-top">
          <a href="/honeypot/logout" class="btn logout">Se déconnecter</a>
        </div>
      </header>

      <section class="filters">
        <label>
          Méthode:
          <select id="methodFilter">
            <option value="">Toutes</option>
            <option>GET</option>
            <option>POST</option>
            <option>PUT</option>
            <option>DELETE</option>
          </select>
        </label>
        <label>
          Chemin:
          <input type="text" id="pathFilter" placeholder="/test" />
        </label>
        <label>
          Résultats / page:
          <select id="limitSelect">
            <option>10</option>
            <option selected>20</option>
            <option>50</option>
            <option>100</option>
          </select>
        </label>
        <button id="refreshBtn" class="btn">Rafraîchir</button>
      </section>

      <section class="downloads">
        <a href="/honeypot/download/json" class="btn">Télécharger JSON</a>
        <a href="/honeypot/download/csv" class="btn">Télécharger CSV</a>
      </section>

      <section class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Méthode</th>
              <th>Chemin</th>
              <th>IP</th>
              <th>User Agent</th>
            </tr>
          </thead>
          <tbody id="logsTableBody">
            <!-- Logs injectés par JS -->
          </tbody>
        </table>
      </section>

      <section class="pagination">
        <button id="prevPage" class="btn">Précédent</button>
        <span id="currentPage">1</span>
        <button id="nextPage" class="btn">Suivant</button>
      </section>
    </div>

    <script>
      let currentPage = 1;

      const methodFilter = document.getElementById("methodFilter");
      const pathFilter = document.getElementById("pathFilter");
      const limitSelect = document.getElementById("limitSelect");
      const refreshBtn = document.getElementById("refreshBtn");
      const prevBtn = document.getElementById("prevPage");
      const nextBtn = document.getElementById("nextPage");
      const logsTableBody = document.getElementById("logsTableBody");
      const currentPageEl = document.getElementById("currentPage");

      async function fetchLogs() {
        const limit = parseInt(limitSelect.value);
        const method = methodFilter.value;
        const path = pathFilter.value;

        try {
          const res = await axios.get(
            `/honeypot/logs?limit=${limit}&page=${currentPage}&method=${method}&path=${path}`,
          );

          const data = res.data;
          const logs = data.logs || [];
          const pageCount = data.page_count || 1;

          renderTable(logs);
          currentPageEl.innerText = `${currentPage} / ${pageCount}`;

          // Pagination
          prevBtn.disabled = currentPage <= 1;
          nextBtn.disabled = currentPage >= pageCount;
        } catch (e) {
          console.error("Erreur récupération logs:", e);
        }
      }

      function renderTable(logs) {
        logsTableBody.innerHTML = "";
        if (logs.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="5" style="text-align:center;color:#aaa;">Aucun log</td>`;
          logsTableBody.appendChild(tr);
          return;
        }
        logs.forEach((log) => {
          const tr = document.createElement("tr");
          const ua =
            (log.headers &&
              (log.headers["User-Agent"] || log.headers["user-agent"])) ||
            "";
          tr.innerHTML = `
      <td>${log.timestamp}</td>
      <td>${log.method}</td>
      <td>${log.path}</td>
      <td>${log.remote_addr}</td>
      <td>${ua}</td>
    `;
          logsTableBody.appendChild(tr);
        });
      }

      refreshBtn.addEventListener("click", () => {
        currentPage = 1;
        fetchLogs();
      });
      prevBtn.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          fetchLogs();
        }
      });
      nextBtn.addEventListener("click", () => {
        currentPage++;
        fetchLogs();
      });
      limitSelect.addEventListener("change", () => {
        currentPage = 1;
        fetchLogs();
      });

      // Initial fetch
      fetchLogs();
    </script>
  </body>
</html>
