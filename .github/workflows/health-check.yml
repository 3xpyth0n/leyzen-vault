name: Health Check

permissions:
  contents: read

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  health-check:
    name: Container health check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      COMPOSE_PROJECT_NAME: leyzen-vault-github-action-${{ github.run_id || format('local-{0}', github.run_attempt) }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Clean up action-specific Docker resources
        run: |
          PROJECT_PREFIX="leyzen-vault-github-action-"
          docker ps -a --format "{{.Names}}" | grep "^${PROJECT_PREFIX}" | xargs -r docker rm -f 2>/dev/null || true
          docker volume ls --format "{{.Name}}" | grep "^${PROJECT_PREFIX}" | xargs -r docker volume rm 2>/dev/null || true
          docker network ls --format "{{.Name}}" | grep "^${PROJECT_PREFIX}" | xargs -r docker network rm 2>/dev/null || true

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r src/orchestrator/requirements.txt
          pip install -r infra/docker-proxy/requirements.txt

      - name: Create .env file with minimal configuration
        run: |
          rm -f .env
          SECRET_KEY=$(openssl rand -hex 32)
          POSTGRES_PASSWORD=$(openssl rand -base64 32)
          cat > .env << EOF
          # Minimal configuration for health check
          LEYZEN_ENVIRONMENT=dev
          ORCH_USER=test_user
          ORCH_PASS=test_pass
          HTTP_PORT=12345
          SECRET_KEY=$SECRET_KEY
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          WEB_REPLICAS=2
          TIMEZONE=UTC
          PROXY_TRUST_COUNT=1
          SESSION_COOKIE_SECURE=false
          POSTGRES_DB=leyzen_vault
          POSTGRES_USER=leyzen
          EOF

      - name: Generate docker-generated.yml
        run: |
          rm -f docker-generated.yml
          python src/compose/build.py
          if [ ! -f docker-generated.yml ]; then
            echo "âŒ ERROR: docker-generated.yml was not created!"
            exit 1
          fi

      - name: Prefix volumes, networks, and containers with project name
        run: |
          python3 << PYEOF
          import re
          import os

          yaml_file = "docker-generated.yml"
          project_prefix = os.environ.get("COMPOSE_PROJECT_NAME", "leyzen-vault-github-action") + "-"

          with open(yaml_file, 'r') as f:
              content = f.read()

          content = re.sub(
              r'(\s+name:\s+)"(leyzen-[^"]+)"',
              lambda m: f'{m.group(1)}"{project_prefix}{m.group(2)}"',
              content
          )

          content = re.sub(
              r'(\s+container_name:\s+)"([^"]+)"',
              lambda m: f'{m.group(1)}"{project_prefix}{m.group(2)}"',
              content
          )

          with open(yaml_file, 'w') as f:
              f.write(content)
          PYEOF

      - name: Build and start containers
        run: |
          docker compose -f docker-generated.yml -p "$COMPOSE_PROJECT_NAME" pull || true
          docker compose -f docker-generated.yml -p "$COMPOSE_PROJECT_NAME" build --no-cache
          docker compose -f docker-generated.yml -p "$COMPOSE_PROJECT_NAME" up -d

      - name: Wait for containers to become healthy
        run: |
          max_attempts=60
          attempt=0

          echo "Phase 1: Waiting for critical services to become healthy..."
          attempt=0
          all_critical_healthy=false

          while [ $attempt -lt $max_attempts ] && [ "$all_critical_healthy" != "true" ]; do
            attempt=$((attempt + 1))
            
            services=$(docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" config --services)
            all_critical_healthy=true
            current_time=$(date +%s)
            
            for service in $services; do
              if [ "$service" = "orchestrator" ]; then
                continue
              fi
              
              container_name=$(docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" ps -q $service 2>/dev/null | head -n1)
              if [ -z "$container_name" ]; then
                if [[ ! "$service" =~ ^vault_web ]]; then
                  all_critical_healthy=false
                fi
                continue
              fi
              
              status=$(docker inspect --format='{{.State.Status}}' $container_name 2>/dev/null || echo "unknown")
              health=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' $container_name 2>/dev/null || echo "none")
              
              if [[ "$service" =~ ^vault_web ]]; then
                if [ "$status" = "running" ] && ([ "$health" = "none" ] || [ "$health" = "healthy" ]); then
                  if [ ! -f "/tmp/${service}_start_time.txt" ]; then
                    echo "$current_time" > "/tmp/${service}_start_time.txt"
                  fi
                fi
              else
                if [ "$status" != "running" ] || ([ "$health" != "none" ] && [ "$health" != "healthy" ]); then
                  all_critical_healthy=false
                else
                  if [ ! -f "/tmp/${service}_start_time.txt" ]; then
                    echo "$current_time" > "/tmp/${service}_start_time.txt"
                  fi
                fi
              fi
            done
            
            if [ "$all_critical_healthy" = "true" ]; then
              echo "âœ… All critical services are healthy"
              break
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              sleep 3
            fi
          done

          if [ "$all_critical_healthy" != "true" ]; then
            echo "âŒ Some critical services failed to become healthy within the timeout period"
            docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" ps
            docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" logs --tail=50
            exit 1
          fi

          echo "Phase 2: Waiting for orchestrator to become healthy..."
          attempt=0
          orchestrator_healthy=false
          while [ $attempt -lt $max_attempts ] && [ "$orchestrator_healthy" != "true" ]; do
            attempt=$((attempt + 1))
            
            orchestrator_container=$(docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" ps -q orchestrator 2>/dev/null | head -n1)
            if [ -n "$orchestrator_container" ]; then
              status=$(docker inspect --format='{{.State.Status}}' $orchestrator_container 2>/dev/null || echo "unknown")
              health=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' $orchestrator_container 2>/dev/null || echo "none")
              
              if [ "$status" = "running" ] && ([ "$health" = "none" ] || [ "$health" = "healthy" ]); then
                orchestrator_healthy=true
                echo "âœ… Orchestrator is healthy"
                echo "$(date +%s)" > /tmp/orchestrator_start_time.txt
                break
              fi
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              sleep 3
            fi
          done

          if [ "$orchestrator_healthy" != "true" ]; then
            echo "âŒ Orchestrator failed to become healthy within the timeout period"
            docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" ps
            docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" logs orchestrator --tail=50
            exit 1
          fi

      - name: Stop orchestrator after health check
        run: |
          echo "Orchestrator is healthy. Waiting 3 seconds before stopping..."
          sleep 3

          echo "Stopping orchestrator..."
          docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" stop orchestrator

          orchestrator_container=$(docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" ps -q orchestrator 2>/dev/null | head -n1)
          if [ -n "$orchestrator_container" ]; then
            sleep 1
            status=$(docker inspect --format='{{.State.Status}}' $orchestrator_container 2>/dev/null || echo "unknown")
            if [ "$status" != "exited" ] && [ "$status" != "stopped" ]; then
              echo "âŒ Orchestrator failed to stop (status: $status)"
              exit 1
            fi
          fi

          echo "âœ… Orchestrator stopped successfully"
          echo "$(date +%s)" > /tmp/orchestrator_end_time.txt

      - name: Verify vault_web services stability
        run: |
          echo "Waiting for vault_web1 and vault_web2 to become healthy..."

          vault_web1_container=$(docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" ps -q vault_web1 2>/dev/null | head -n1)
          vault_web2_container=$(docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" ps -q vault_web2 2>/dev/null | head -n1)

          if [ -z "$vault_web1_container" ] || [ -z "$vault_web2_container" ]; then
            echo "âŒ vault_web1 or vault_web2 container not found"
            echo "vault_web1: ${vault_web1_container:-not found}"
            echo "vault_web2: ${vault_web2_container:-not found}"
            exit 1
          fi

          max_attempts=20
          attempt=0
          vault_web_healthy=false

          while [ $attempt -lt $max_attempts ] && [ "$vault_web_healthy" != "true" ]; do
            attempt=$((attempt + 1))
            
            vault_web1_status=$(docker inspect --format='{{.State.Status}}' $vault_web1_container 2>/dev/null || echo "unknown")
            vault_web1_health=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' $vault_web1_container 2>/dev/null || echo "none")
            vault_web2_status=$(docker inspect --format='{{.State.Status}}' $vault_web2_container 2>/dev/null || echo "unknown")
            vault_web2_health=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' $vault_web2_container 2>/dev/null || echo "none")
            
            if [ "$vault_web1_status" = "running" ] && ([ "$vault_web1_health" = "none" ] || [ "$vault_web1_health" = "healthy" ]) && \
               [ "$vault_web2_status" = "running" ] && ([ "$vault_web2_health" = "none" ] || [ "$vault_web2_health" = "healthy" ]); then
              vault_web_healthy=true
              echo "âœ… vault_web1 and vault_web2 are healthy"
              current_time=$(date +%s)
              if [ ! -f "/tmp/vault_web1_start_time.txt" ]; then
                echo "$current_time" > /tmp/vault_web1_start_time.txt
              fi
              if [ ! -f "/tmp/vault_web2_start_time.txt" ]; then
                echo "$current_time" > /tmp/vault_web2_start_time.txt
              fi
              break
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              sleep 2
            fi
          done

          if [ "$vault_web_healthy" != "true" ]; then
            echo "âŒ vault_web1 or vault_web2 failed to become healthy within the timeout period"
            echo "vault_web1: status=$vault_web1_status, health=$vault_web1_health"
            echo "vault_web2: status=$vault_web2_status, health=$vault_web2_health"
            exit 1
          fi

          echo "Waiting 3 seconds to verify stability..."
          sleep 3

          vault_web1_status=$(docker inspect --format='{{.State.Status}}' $vault_web1_container 2>/dev/null || echo "unknown")
          vault_web1_health=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' $vault_web1_container 2>/dev/null || echo "none")
          vault_web2_status=$(docker inspect --format='{{.State.Status}}' $vault_web2_container 2>/dev/null || echo "unknown")
          vault_web2_health=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' $vault_web2_container 2>/dev/null || echo "none")

          if [ "$vault_web1_status" != "running" ] || ([ "$vault_web1_health" != "none" ] && [ "$vault_web1_health" != "healthy" ]); then
            echo "âŒ vault_web1 is no longer healthy after 3 seconds (status: $vault_web1_status, health: $vault_web1_health)"
            exit 1
          fi

          if [ "$vault_web2_status" != "running" ] || ([ "$vault_web2_health" != "none" ] && [ "$vault_web2_health" != "healthy" ]); then
            echo "âŒ vault_web2 is no longer healthy after 3 seconds (status: $vault_web2_status, health: $vault_web2_health)"
            exit 1
          fi

          echo "âœ… vault_web1 and vault_web2 remained healthy for 3 seconds after orchestrator was stopped"
          end_time=$(date +%s)
          echo "$end_time" > /tmp/vault_web1_end_time.txt
          echo "$end_time" > /tmp/vault_web2_end_time.txt

          services=$(docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" config --services)
          for service in $services; do
            if [ "$service" != "orchestrator" ] && [[ ! "$service" =~ ^vault_web ]]; then
              echo "$end_time" > "/tmp/${service}_end_time.txt"
            fi
          done

      - name: Health check duration summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š HEALTH CHECK DURATION SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          printf "%-20s %-15s\n" "Container" "Duration"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          services=$(docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" config --services 2>/dev/null || echo "")
          displayed_services=""

          for service in $services; do
            start_file="/tmp/${service}_start_time.txt"
            end_file="/tmp/${service}_end_time.txt"
            
            if [ -f "$start_file" ] && [ -f "$end_file" ]; then
              start_time=$(cat "$start_file")
              end_time=$(cat "$end_file")
              duration=$((end_time - start_time))
              
              if [ $duration -ge 0 ]; then
                minutes=$((duration / 60))
                seconds=$((duration % 60))
                
                if [ $minutes -gt 0 ]; then
                  duration_str="${minutes}m ${seconds}s"
                else
                  duration_str="${seconds}s"
                fi
                
                printf "%-20s %-15s\n" "$service" "$duration_str"
                displayed_services="${displayed_services} ${service}"
              else
                printf "%-20s %-15s\n" "$service" "N/A (invalid)"
                displayed_services="${displayed_services} ${service}"
              fi
            elif [ -f "$start_file" ]; then
              printf "%-20s %-15s\n" "$service" "N/A (no end time)"
              displayed_services="${displayed_services} ${service}"
            elif [ -f "$end_file" ]; then
              printf "%-20s %-15s\n" "$service" "N/A (no start time)"
              displayed_services="${displayed_services} ${service}"
            fi
          done

          for vault_service in vault_web1 vault_web2; do
            if echo "$displayed_services" | grep -q " ${vault_service} "; then
              continue
            fi
            
            start_file="/tmp/${vault_service}_start_time.txt"
            end_file="/tmp/${vault_service}_end_time.txt"
            
            if [ -f "$start_file" ] && [ -f "$end_file" ]; then
              start_time=$(cat "$start_file")
              end_time=$(cat "$end_file")
              duration=$((end_time - start_time))
              
              if [ $duration -ge 0 ]; then
                minutes=$((duration / 60))
                seconds=$((duration % 60))
                
                if [ $minutes -gt 0 ]; then
                  duration_str="${minutes}m ${seconds}s"
                else
                  duration_str="${seconds}s"
                fi
                
                printf "%-20s %-15s\n" "$vault_service" "$duration_str"
              else
                printf "%-20s %-15s\n" "$vault_service" "N/A (invalid duration)"
              fi
            elif [ -f "$start_file" ]; then
              printf "%-20s %-15s\n" "$vault_service" "N/A (no end time)"
            elif [ -f "$end_file" ]; then
              printf "%-20s %-15s\n" "$vault_service" "N/A (no start time)"
            else
              printf "%-20s %-15s\n" "$vault_service" "N/A (no timestamps)"
            fi
          done

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-generated.yml -p "${COMPOSE_PROJECT_NAME}" down -v || true

          PROJECT_PREFIX="${COMPOSE_PROJECT_NAME}-"
          docker ps -a --format "{{.Names}}" | grep "^${PROJECT_PREFIX}" | xargs -r docker rm -f 2>/dev/null || true
          docker volume ls --format "{{.Name}}" | grep "^${PROJECT_PREFIX}" | xargs -r docker volume rm 2>/dev/null || true
          docker network ls --format "{{.Name}}" | grep "^${PROJECT_PREFIX}" | xargs -r docker network rm 2>/dev/null || true
